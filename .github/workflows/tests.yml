name: tests
on:
  pull_request:
    paths:
      - 'packages/**/*.pacscript'
defaults:
  run:
    shell: bash
jobs:
  install-package:
    strategy:
      matrix:
        OS: ["ubuntu:latest", "ubuntu:devel", "ubuntu:rolling", "debian:stable", "debian:testing", "debian:unstable"]
    runs-on: ubuntu-latest
    container: ${{ matrix.OS }}
    steps:
      - name: install system utilities
        run: |
          apt-get update
          apt-get install curl bash wget git sudo iputils-ping -y
      - id: checkout
        uses: actions/checkout@v2
      - id: files
        uses: jitterbit/get-changed-files@v1
      - name: Installing pacstall
        run: |
           curl -fsSL https://git.io/JsADh > pacstall-install.sh
           chmod +x ./pacstall-install.sh
           echo N\n | sudo ./pacstall-install.sh
           rm ./pacstall-install.sh
        env:
          TERM: xterm
          shell: bash
      - name: setup test user
        run: |
          sudo useradd $USER
          sudo adduser $USER sudo
          sudo sed -i "s/%sudo   ALL=(ALL:ALL) ALL/%sudo  ALL=(ALL) NOPASSWD:ALL/g" /etc/sudoers
          sudo mkdir -p /home/$USER
          sudo chown -R $USER:$USER /home/$USER
          sudo chown -R $USER:$USER /tmp
          sudo chmod -R 777 /tmp
          echo "Loggged in as $(whoami)"
        env:
          USER: dio
          LOGNAME: dio
      - name: Installing packages with pacstall
        run: |
          for changed_file in ${{ steps.files.outputs.added_modified }}; do
            if [[ ${changed_file} == *".pacscript" ]]; then
              pacscript_file=`basename "${changed_file}"`
              package_name="${pacscript_file/.pacscript/ }"
              package_dir=`dirname "${changed_file}"`
              echo "Running pacstall -I for ${package_name}..."
              echo "pacstall -Il ${package_name}"
              cd ${package_dir}
              pacstall --disable-prompts -Il ${package_name}
              ls -al /tmp/pacstall/
            fi
          done
        env:
          TERM: xterm
          shell: bash
