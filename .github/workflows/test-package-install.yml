name: test-package-install
on:
  pull_request:
    paths:
      - 'packages/**/*.pacscript'
jobs:
  run-pacstall-install-for-package:
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v2
      - id: files
        uses: jitterbit/get-changed-files@v1
      - name: Installing pacstall
        run: |
          export PACSTALL_SKIP_NETWORK_CHECK=1
          sudo bash -c "$(wget -q https://git.io/JsADh -O -)"
          sudo adduser --disabled-password --gecos '' pacstall
          sudo adduser pacstall sudo
          echo '%sudo ALL=(ALL) NOPASSWD:ALL' | sudo tee -a /etc/sudoers >/dev/null
      - name: Installing packages with pacstall (develop)
        run: |
          pacstall -PU pacstall develop
          sudo sed -i 's|export SRCDIR="/tmp/pacstall"|export SRCDIR="$HOME/pacstall"|' /bin/pacstall
          sudo su - pacstall
          echo "Chowning /$HOME/pacstall"
          mkdir -pv $HOME/pacstall
          sudo chown -Rv pacstall:pacstall /var/log/pacstall
          sudo dpkg --add-architecture i386
          sudo add-apt-repository universe
          sudo apt-get update
          sudo chown -Rv pacstall:pacstall /$HOME/pacstall
          for changed_file in ${{ steps.files.outputs.added_modified }}; do
            if [[ ${changed_file} == *".pacscript" ]]; then
              pacscript_file=`basename "${changed_file}"`
              package_name="${pacscript_file/.pacscript/ }"
              package_dir=`dirname "${changed_file}"`
              echo "pacstall -Il ${package_name}"
              cd ${package_dir}
              pacstall --disable-prompts -Il ${package_name}
              pacstall --disable-prompts -R ${package_name}
            fi
          done
      - name: Installing packages with pacstall (master)
        run: |
          sudo rm -rf /tmp/pacstall
          pacstall -PU pacstall master
          sudo su - pacstall
          echo "Chowning /tmp/pacstall"
          sudo chown -Rv pacstall:pacstall /var/log/pacstall
          sudo dpkg --add-architecture i386
          sudo add-apt-repository universe
          sudo apt-get update
          sudo chown -Rv pacstall:pacstall /tmp/pacstall
          for changed_file in ${{ steps.files.outputs.added_modified }}; do
            if [[ ${changed_file} == *".pacscript" ]]; then
              pacscript_file=`basename "${changed_file}"`
              package_name="${pacscript_file/.pacscript/ }"
              package_dir=`dirname "${changed_file}"`
              echo "pacstall -Il ${package_name}"
              cd ${package_dir}
              pacstall --disable-prompts -Il ${package_name}
              pacstall --disable-prompts -R ${package_name}
            fi
          done
        env:
          TERM: xterm
